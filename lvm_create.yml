---
# filesystem_redhat.yml - Red Hat Filesystem Tasks Only
    # --- Filesystem Setup ---
    - name: Create filesystem directories
      file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
        mode: "{{ item.mode | default('0755') }}"
      loop: "{{ filesystem_dirs }}"

    - name: Create disk image files for filesystem
      shell: |
        if [ ! -f {{ item.path }}.img ]; then
          dd if=/dev/zero of={{ item.path }}.img bs=1M count={{ item.size_mb }}
          mkfs.ext4 -F {{ item.path }}.img
        fi
      loop: "{{ filesystem_dirs }}"
      when: item.create_disk | default(false)

    - name: Mount filesystem directories
      mount:
        path: "{{ item.path }}"
        src: "{{ item.path }}.img"
        fstype: ext4
        opts: loop
        state: mounted
      loop: "{{ filesystem_dirs }}"
      when: item.create_disk | default(false)

    - name: Add to /etc/fstab for persistent mount
      mount:
        path: "{{ item.path }}"
        src: "{{ item.path }}.img"
        fstype: ext4
        opts: loop
        state: present
      loop: "{{ filesystem_dirs }}"
      when: item.create_disk | default(false)

    - name: Set ownership after mount
      file:
        path: "{{ item.path }}"
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
        mode: "{{ item.mode | default('0755') }}"
        recurse: yes
      loop: "{{ filesystem_dirs }}"
      when: item.create_disk | default(false)

    - name: Verify filesystem mount point
      command: "df -h {{ item.path }}"
      register: mount_check
      loop: "{{ filesystem_dirs }}"
      when: item.create_disk | default(false)

    - name: Display mount status
      debug:
        msg: "{{ item.stdout }}"
      loop: "{{ mount_check.results }}"
      when: item.stdout is defined