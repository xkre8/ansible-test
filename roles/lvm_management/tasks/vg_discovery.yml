---
- name: Check for existing Volume Groups
  ansible.builtin.command: vgs --noheadings -o vg_name
  register: vg_list_result
  changed_when: false
  failed_when: false

- name: Initialize available VGs list
  ansible.builtin.set_fact:
    available_vgs: []

- name: Build available VGs list safely
  ansible.builtin.set_fact:
    available_vgs: "{{ available_vgs + [vg_line | trim] }}"
  loop: "{{ vg_list_result.stdout_lines | default([]) }}"
  loop_control:
    loop_var: vg_line
  when: 
    - vg_line is defined
    - vg_line | trim != ""

- name: Get detailed VG information
  ansible.builtin.command: vgs --noheadings -o vg_name,vg_size,vg_free --units m
  register: vg_details_result
  changed_when: false
  failed_when: false
  when: available_vgs | length > 0

- name: Display enhanced VG information
  ansible.builtin.debug:
    msg: |
      📦 Enhanced Volume Group Discovery:
      
      Strategy: {{ vg_strategy | default(vg_action) }}
      Target VG: {{ volume_group_name }}
      
      Available Volume Groups:
      {% if available_vgs | length > 0 %}
      {% for vg in available_vgs %}
      - {{ vg }}
      {% endfor %}
      
      Details:
      {{ vg_details_result.stdout | default('No details available') }}
      {% else %}
      None found
      {% endif %}
      
      Action Plan:
      {% if vg_strategy | default(vg_action) == 'create_new' or vg_action == 'create' %}
      🆕 Will create new VG '{{ volume_group_name }}'{% if lvm_device is defined %} on {{ lvm_device }}{% endif %}
      {% elif vg_strategy | default(vg_action) == 'use_existing' or vg_action == 'use_existing' %}
      📋 Will use existing VG '{{ volume_group_name }}'
      {% elif vg_strategy | default(vg_action) == 'extend_existing' or vg_action == 'extend' %}
      📈 Will extend VG '{{ volume_group_name }}'{% if lvm_device is defined %} with {{ lvm_device }}{% endif %}
      {% endif %}

- name: Validate existing VG for use_existing strategy
  ansible.builtin.fail:
    msg: |
      ❌ VG Strategy Validation Failed!
      
      Strategy: use_existing
      Requested VG: {{ volume_group_name }}
      Available VGs: {{ available_vgs | join(', ') if available_vgs | length > 0 else 'None' }}
      
      💡 Available options:
      {% for vg in available_vgs %}
      - {{ vg }}
      {% endfor %}
      
      ✏️ Please update your configuration to use one of the available VGs.
  when:
    - vg_strategy | default(vg_action) == "use_existing" or vg_action == "use_existing"
    - volume_group_name not in available_vgs

- name: Auto-adjust strategy for existing VG
  ansible.builtin.set_fact:
    vg_strategy: "extend_existing"
    vg_action: "extend"
  when:
    - vg_strategy | default(vg_action) == "create_new" or vg_action == "create"
    - volume_group_name in available_vgs

- name: Display strategy auto-adjustment
  ansible.builtin.debug:
    msg: |
      🔄 Strategy Auto-Adjustment:
      Original: create_new/create
      Adjusted: extend_existing/extend
      Reason: VG '{{ volume_group_name }}' already exists
      
      ℹ️ Will extend existing VG{% if lvm_device is defined %} with {{ lvm_device }}{% endif %}
  when:
    - (vg_strategy | default(vg_action) == "extend_existing" or vg_action == "extend")
    - volume_group_name in available_vgs
