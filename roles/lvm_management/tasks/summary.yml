---
- name: Gather LVM summary information
  ansible.builtin.shell: |
    echo "=== PHYSICAL VOLUMES ==="
    {% if lvm_device is defined and lvm_device != "" %}
    pvs {{ lvm_device }} 2>/dev/null || echo "No PV on {{ lvm_device }}"
    {% endif %}
    echo ""
    echo "=== VOLUME GROUP ==="
    vgs {{ volume_group_name }} 2>/dev/null || echo "VG {{ volume_group_name }} not found"
    echo ""
    echo "=== LOGICAL VOLUMES ==="
    lvs {{ volume_group_name }} 2>/dev/null || echo "No LVs in {{ volume_group_name }}"
  register: lvm_summary
  changed_when: false
  failed_when: false

- name: Display deployment summary
  ansible.builtin.debug:
    msg: |
      
      üéØ ===== LVM DEPLOYMENT SUMMARY =====
      
      üìã Configuration:
      - Volume Group: {{ volume_group_name }}
      - Action: {{ vg_action }}
      {% if lvm_device is defined and lvm_device != "" %}
      - Device: {{ lvm_device }}
      {% endif %}
      
      üóÇÔ∏è Filesystems Created:
      {% for fs in filesystem_dirs | selectattr('create_lvm', 'equalto', true) %}
      - {{ fs.path }}: {{ fs.size_mb }}MB ({{ fs.fstype }})
      {% endfor %}
      
      üìä LVM Details:
      {{ lvm_summary.stdout }}
      
      ‚úÖ Deployment completed successfully!

- name: Create summary report
  ansible.builtin.copy:
    content: |
      LVM Deployment Report
      ====================
      Date: {{ ansible_date_time.iso8601 }}
      Host: {{ inventory_hostname }}
      
      Configuration:
      - Volume Group: {{ volume_group_name }}
      - Action: {{ vg_action }}
      {% if lvm_device is defined and lvm_device != "" %}
      - Device: {{ lvm_device }}
      {% endif %}
      
      Filesystems:
      {% for fs in filesystem_dirs | selectattr('create_lvm', 'equalto', true) %}
      - {{ fs.path }}: {{ fs.size_mb }}MB ({{ fs.fstype }}, {{ fs.owner }}:{{ fs.group }}, {{ fs.mode }})
      {% endfor %}
      
      LVM Information:
      {{ lvm_summary.stdout }}
    dest: "/tmp/lvm_deployment_{{ volume_group_name }}_{{ ansible_date_time.epoch }}.txt"
  delegate_to: localhost
  run_once: true