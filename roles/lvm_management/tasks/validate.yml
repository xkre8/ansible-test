---
- name: Install required packages
  ansible.builtin.package:
    name: lvm2
    state: present

- name: Parse filesystem configuration
  ansible.builtin.set_fact:
    parsed_filesystems: "{{ filesystem_config | from_yaml }}"
  when: filesystem_config is defined and filesystem_config | length > 0

- name: Initialize filesystem_dirs
  ansible.builtin.set_fact:
    filesystem_dirs: []

- name: Build filesystem configuration
  ansible.builtin.set_fact:
    filesystem_dirs: "{{ filesystem_dirs + [item] }}"
  vars:
    item:
      path: "{{ fs.path }}"
      lv_name: "{{ fs.lv_name }}"
      owner: "{{ fs.owner | default(default_owner) }}"
      group: "{{ fs.group | default(default_group) }}"
      mode: "{{ fs.mode | default(default_mode) }}"
      create_lvm: "{{ fs.create_lvm | default(true) }}"
      size_mb: "{{ fs.size_mb }}"
      fstype: "{{ fs.fstype | default(default_fstype) }}"
      mount_opts: "{{ fs.mount_opts | default(default_mount_opts) }}"
  loop: "{{ parsed_filesystems | default([]) }}"
  loop_control:
    loop_var: fs

- name: Determine LVM device path
  ansible.builtin.set_fact:
    lvm_device: >-
      {{ 
        manual_lvm_device if (manual_lvm_device is defined and manual_lvm_device != '') 
        else ('/dev/' + selected_disk_name) if (selected_disk_name is defined and selected_disk_name != '') 
        else lvm_device 
      }}

- name: Determine VG action and name
  ansible.builtin.set_fact:
    vg_action: "{{ 'use_existing' if (use_existing_vg | default(false) | bool) else vg_action }}"
    volume_group_name: "{{ existing_vg_name if (use_existing_vg | default(false) | bool and existing_vg_name != '') else volume_group_name }}"

- name: Validate configuration
  ansible.builtin.assert:
    that:
      - volume_group_name != ""
      - filesystem_dirs | length > 0
      - (lvm_device != "" or vg_action == "use_existing")
    fail_msg: |
      ‚ùå Configuration validation failed:
      - Volume Group Name: {{ volume_group_name }}
      - LVM Device: {{ lvm_device }}
      - VG Action: {{ vg_action }}
      - Filesystem Count: {{ filesystem_dirs | length }}