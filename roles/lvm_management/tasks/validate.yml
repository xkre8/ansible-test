- name: Debug all disk-related variables
  ansible.builtin.debug:
    msg: |
      🔍 Disk Variables Debug:
      manual_lvm_device: {{ manual_lvm_device | default('NOT_SET') }}
      selected_disk_name: {{ selected_disk_name | default('NOT_SET') }}
      discovered_disk: {{ discovered_disk | default('NOT_SET') }}
      discovered_disk type: {{ discovered_disk | type_debug if discovered_disk is defined else 'NOT_SET' }}
      current lvm_device: {{ lvm_device | default('NOT_SET') }}

# ปรับปรุงการกำหนด LVM device path
- name: Determine LVM device path (enhanced)
  ansible.builtin.set_fact:
    lvm_device: >-
      {% if manual_lvm_device is defined and manual_lvm_device != '' %}
      {{ manual_lvm_device }}
      {% elif discovered_disk is defined %}
        {% if discovered_disk is mapping and discovered_disk.stdout is defined %}
      /dev/{{ discovered_disk.stdout | trim }}
        {% elif discovered_disk is string %}
      /dev/{{ discovered_disk | trim }}
        {% else %}
      {{ lvm_device | default('') }}
        {% endif %}
      {% elif selected_disk_name is defined and selected_disk_name != '' %}
      /dev/{{ selected_disk_name }}
      {% else %}
      {{ lvm_device | default('') }}
      {% endif %}

- name: Validate final LVM device path
  ansible.builtin.debug:
    msg: |
      ✅ Final LVM Device Configuration:
      Path: {{ lvm_device }}
      Valid: {{ (lvm_device != '' and lvm_device != '/dev/') | bool }}
      Strategy: {{ vg_strategy | default(vg_action) }}
      Required: {{ (vg_strategy | default(vg_action)) not in ['use_existing'] }}