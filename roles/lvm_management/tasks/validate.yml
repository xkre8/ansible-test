# ❌ โค้ดที่ผิด (น่าจะมีแฝงอยู่)
- name: Auto-discover available disk
  ansible.builtin.shell: |
    lsblk -ndo NAME,TYPE | awk '$2=="disk" && !/^(loop|sr)/ {print "/dev/"$1; exit}'
  register: discovered_disk
  changed_when: false
  when: lvm_device == ""

- name: Set LVM device from discovery
  ansible.builtin.set_fact:
    lvm_device: "{{ discovered_disk.stdout | trim }}"
  when: discovered_disk.stdout != ""  # ← ปัญหาตรงนี้

# ✅ โค้ดที่ถูกต้อง
- name: Auto-discover available disk
  ansible.builtin.shell: |
    lsblk -ndo NAME,TYPE | awk '$2=="disk" && !/^(loop|sr)/ {print "/dev/"$1; exit}'
  register: discovered_disk_result
  changed_when: false
  failed_when: false
  when: lvm_device == ""

- name: Set LVM device from discovery
  ansible.builtin.set_fact:
    lvm_device: "{{ discovered_disk_result.stdout | trim }}"
  when: 
    - discovered_disk_result is defined
    - discovered_disk_result.stdout is defined
    - discovered_disk_result.stdout != ""
    - lvm_device == ""

# หรือแบบปลอดภัยกว่า
- name: Set LVM device from discovery (Safe)
  ansible.builtin.set_fact:
    lvm_device: "{{ discovered_disk_result.stdout | trim }}"
  when: 
    - discovered_disk_result is not skipped
    - discovered_disk_result.stdout | default('') != ""