---
# === PARTITION CREATION (Create New Path) ===
- name: Display partition plan
  ansible.builtin.debug:
    msg: |
      🔧 PARTITION CREATION PLAN:
      📀 Target disk: {{ base_disk }}
      📊 Strategy: {{ 'Split into 2 partitions' if split_disk else 'Use whole disk or single partition' }}
      
      {% if partition_strategy == 'create_partition' and split_disk %}
      📋 Partition 1: 0% → {{ partition_size_gb }}GB (for {{ volume_group_name }})
      📋 Partition 2: {{ partition_size_gb }}GB → 100% (for {{ volume_group2_name }})
      {% elif partition_strategy == 'create_partition' %}
      📋 Single partition: 0% → 100% (for {{ volume_group_name }})
      {% else %}
      📋 Use whole disk (no partitioning)
      {% endif %}

# === CREATE PARTITIONS ===
- name: Create GPT partition table and clear existing data
  ansible.builtin.shell: |
    wipefs -a {{ base_disk }} 2>/dev/null || true
    parted {{ base_disk }} --script mklabel gpt
  when: partition_strategy == 'create_partition'

- name: Create single partition (whole disk)
  community.general.parted:
    device: "{{ base_disk }}"
    number: 1
    part_start: 1MiB
    part_end: 100%
    state: present
  when: 
    - partition_strategy == 'create_partition'
    - not split_disk

- name: Create dual partitions (split disk) - Fixed sizing
  community.general.parted:
    device: "{{ base_disk }}"
    number: "{{ item.number }}"
    part_start: "{{ item.start }}"
    part_end: "{{ item.end }}"
    state: present
  loop:
    - { number: 1, start: "1MiB", end: "{{ partition_size_gb }}GiB" }
    - { number: 2, start: "{{ partition_size_gb }}GiB", end: "100%" }
  when: 
    - partition_strategy == 'create_partition'
    - split_disk

# === WAIT FOR DEVICES ===
- name: Wait for partition devices (single)
  ansible.builtin.wait_for:
    path: "{{ base_disk }}1"
    timeout: 30
  when: 
    - partition_strategy == 'create_partition'
    - not split_disk

- name: Wait for partition devices (dual)
  ansible.builtin.wait_for:
    path: "{{ base_disk }}{{ item }}"
    timeout: 30
  loop: [1, 2]
  when: 
    - partition_strategy == 'create_partition'
    - split_disk

# === SET TARGET DEVICES ===
- name: Set target devices for VG creation
  ansible.builtin.set_fact:
    primary_device: >-
      {%- if partition_strategy == 'create_partition' -%}
        {{ base_disk }}1
      {%- else -%}
        {{ base_disk }}
      {%- endif -%}
    secondary_device: >-
      {%- if partition_strategy == 'create_partition' and split_disk -%}
        {{ base_disk }}2
      {%- else -%}
        ""
      {%- endif -%}

- name: Display partition plan
  ansible.builtin.debug:
    msg: |
      🔧 PARTITION CREATION PLAN:
      📀 Target disk: {{ base_disk }}
      📊 Strategy: {{ 'Split into 2 partitions' if split_disk else 'Use whole disk or single partition' }}
      
      {% if partition_strategy == 'create_partition' and split_disk %}
      📋 Partition 1: 1MiB → {{ partition_size_gb }}GiB (for {{ volume_group_name }})
      📋 Partition 2: {{ partition_size_gb }}GiB → 100% (for {{ volume_group2_name }})
      🗂️  Secondary FS: {{ 'Create filesystems' if create_secondary_filesystem else 'VG only (no filesystems)' }}
      {% elif partition_strategy == 'create_partition' %}
      📋 Single partition: 1MiB → 100% (for {{ volume_group_name }})
      {% else %}
      📋 Use whole disk (no partitioning)
      {% endif %}