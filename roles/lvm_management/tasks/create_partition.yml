---
# === PARTITION CREATION (Create New Path) ===
- name: Display partition plan
  ansible.builtin.debug:
    msg: |
      ðŸ”§ PARTITION CREATION PLAN:
      ðŸ“€ Target disk: {{ base_disk }}
      ðŸ“Š Strategy: {{ 'Split into 2 partitions' if split_disk else 'Use whole disk or single partition' }}
      
      {% if partition_strategy == 'create_partition' and split_disk %}
      ðŸ“‹ Partition 1: 0% â†’ {{ partition_size_gb }}GB (for {{ volume_group_name }})
      ðŸ“‹ Partition 2: {{ partition_size_gb }}GB â†’ 100% (for {{ volume_group2_name }})
      {% elif partition_strategy == 'create_partition' %}
      ðŸ“‹ Single partition: 0% â†’ 100% (for {{ volume_group_name }})
      {% else %}
      ðŸ“‹ Use whole disk (no partitioning)
      {% endif %}

# === CREATE PARTITIONS ===
- name: Create GPT partition table and clear existing data
  ansible.builtin.shell: |
    wipefs -a {{ base_disk }} 2>/dev/null || true
    parted {{ base_disk }} --script mklabel gpt
  when: partition_strategy == 'create_partition'

- name: Create single partition (whole disk)
  community.general.parted:
    device: "{{ base_disk }}"
    number: 1
    part_start: 1MiB
    part_end: 100%
    state: present
  when: 
    - partition_strategy == 'create_partition'
    - not split_disk

- name: Create dual partitions (split disk) - Fixed sizing
  community.general.parted:
    device: "{{ base_disk }}"
    number: "{{ item.number }}"
    part_start: "{{ item.start }}"
    part_end: "{{ item.end }}"
    state: present
  loop:
    - { number: 1, start: "1MiB", end: "{{ partition_size_gb }}GiB" }
    - { number: 2, start: "{{ partition_size_gb }}GiB", end: "100%" }
  when: 
    - partition_strategy == 'create_partition'
    - split_disk

# === WAIT FOR DEVICES ===
- name: Wait for partition devices (single)
  ansible.builtin.wait_for:
    path: "{{ base_disk }}1"
    timeout: 30
  when: 
    - partition_strategy == 'create_partition'
    - not split_disk

- name: Wait for partition devices (dual)
  ansible.builtin.wait_for:
    path: "{{ base_disk }}{{ item }}"
    timeout: 30
  loop: [1, 2]
  when: 
    - partition_strategy == 'create_partition'
    - split_disk

# === SET TARGET DEVICES ===
- name: Set target devices for VG creation
  ansible.builtin.set_fact:
    primary_device: >-
      {%- if partition_strategy == 'create_partition' -%}
        {{ base_disk }}1
      {%- else -%}
        {{ base_disk }}
      {%- endif -%}
    secondary_device: >-
      {%- if partition_strategy == 'create_partition' and split_disk -%}
        {{ base_disk }}2
      {%- else -%}
        ""
      {%- endif -%}

- name: Display partition results
  ansible.builtin.debug:
    msg: |
      âœ… PARTITION CREATION COMPLETE:
      ðŸŽ¯ Primary device: {{ primary_device }} â†’ {{ volume_group_name }}
      {% if split_disk %}
      ðŸŽ¯ Secondary device: {{ secondary_device }} â†’ {{ volume_group2_name }}
      {% endif %}
      
      ðŸ“Š Final layout:
      {{ ansible_lsblk[selected_disk_name] | default('Device info not available') }}