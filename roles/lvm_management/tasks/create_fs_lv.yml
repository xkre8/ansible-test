- name: Generate LV names for secondary VG
  ansible.builtin.set_fact:
    secondary_fs_dirs: "{{ enhanced_fs_config2 }}"
  vars:
    enhanced_fs_config2: >-
      {%- set result = [] -%}
      {%- for item in parsed_fs_config2 -%}
        {%- if item.lv_name is defined and item.lv_name != '' -%}
          {%- set final_lv_name = item.lv_name | regex_replace('[^a-zA-Z0-9_-]', '_') -%}
        {%- else -%}
          {%- set final_lv_name = (item.path | regex_replace('^/', '') | regex_replace('[^a-zA-Z0-9_-]', '_')) + '_lv' -%}
        {%- endif -%}
        {%- set _ = result.append(item | combine({'lv_name': final_lv_name, 'vg_name': volume_group2_name})) -%}
      {%- endfor -%}
      {{ result }}
  when: 
    - split_disk
    - create_secondary_filesystem

# === SIZE VALIDATION ===
- name: Validate secondary VG has enough space
  ansible.builtin.assert:
    that:
      - "{{ total_fs2_size_mb }} <= {{ secondary_vg_info.stdout.split()[1] | int }}"
    fail_msg: "Insufficient space in {{ volume_group2_name }}. Required: {{ total_fs2_size_mb }}MB, Available: {{ secondary_vg_info.stdout.split()[1] }}MB"
  when: 
    - split_disk
    - create_secondary_filesystem
    - secondary_fs_dirs | length > 0
    - secondary_vg_info is defined

# === CREATE LOGICAL VOLUMES ===
- name: Create logical volumes (secondary VG)
  community.general.lvol:
    vg: "{{ volume_group2_name }}"
    lv: "{{ item.lv_name }}"
    size: "{{ item.size_mb }}M"
    state: present
  loop: "{{ secondary_fs_dirs }}"
  when: 
    - split_disk
    - create_secondary_filesystem
    - secondary_fs_dirs | length > 0

# === CREATE FILESYSTEMS ===
- name: Create filesystems (secondary VG)
  community.general.filesystem:
    fstype: "{{ item.fstype }}"
    dev: "/dev/{{ volume_group2_name }}/{{ item.lv_name }}"
    state: present
  loop: "{{ secondary_fs_dirs }}"
  when: 
    - split_disk
    - create_secondary_filesystem
    - secondary_fs_dirs | length > 0

# === CREATE MOUNT POINTS ===
- name: Create mount points (secondary VG)
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    mode: '0755'
  loop: "{{ secondary_fs_dirs }}"
  when: 
    - split_disk
    - create_secondary_filesystem
    - secondary_fs_dirs | length > 0

# === MOUNT FILESYSTEMS ===
- name: Mount filesystems (secondary VG)
  ansible.posix.mount:
    path: "{{ item.path }}"
    src: "/dev/mapper/{{ volume_group2_name }}-{{ item.lv_name }}"
    fstype: "{{ item.fstype }}"
    opts: defaults
    state: mounted
  loop: "{{ secondary_fs_dirs }}"
  when: 
    - split_disk
    - create_secondary_filesystem
    - secondary_fs_dirs | length > 0

# === DISPLAY SECONDARY VG STATUS ===
- name: Display secondary VG status
  ansible.builtin.debug:
    msg: |
      ðŸ“¦ SECONDARY VG STATUS:
      {% if split_disk and not create_secondary_filesystem %}
      ðŸŽ¯ {{ volume_group2_name }}: Created as empty VG (no filesystems)
      ðŸ’¡ Available for future use: {{ secondary_vg_info.stdout.split()[1] if secondary_vg_info is defined else 'Unknown' }}MB
      {% elif split_disk and create_secondary_filesystem %}
      ðŸŽ¯ {{ volume_group2_name }}: Created with {{ secondary_fs_dirs | length if secondary_fs_dirs is defined else 0 }} filesystems
      {% else %}
      ðŸŽ¯ Secondary VG: Not applicable (single partition mode)
      {% endif %}
  when: split_disk