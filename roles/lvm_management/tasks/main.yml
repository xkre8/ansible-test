---
- name: Install LVM packages
  ansible.builtin.package:
    name: lvm2
    state: present

- name: Parse filesystem configuration
  ansible.builtin.set_fact:
    filesystem_dirs: "{{ (filesystem_config | from_yaml) if filesystem_config is defined else [] }}"

- name: Validate configuration
  ansible.builtin.include_tasks: validate.yml

- name: Set target device
  ansible.builtin.set_fact:
    target_device: >-
      {%- if pv_strategy == 'use_existing_pv' -%}
        {{ existing_pv_device }}
      {%- elif manual_lvm_device != '' -%}
        {{ manual_lvm_device }}
      {%- elif selected_disk_name != '' -%}
        {{ '/dev/' + selected_disk_name }}
      {%- endif -%}

# === PHYSICAL VOLUME ===
- name: Create Physical Volume (if needed)
  ansible.builtin.command: pvcreate {{ target_device }}
  register: pv_result
  failed_when: pv_result.rc != 0 and 'already' not in pv_result.stderr
  changed_when: pv_result.rc == 0 and 'already' not in pv_result.stderr
  when: 
    - pv_strategy == 'create_new_pv'
    - vg_strategy in ['create_new', 'extend_existing']

# === VOLUME GROUP ===
- name: Create/Extend Volume Group
  community.general.lvg:
    vg: "{{ volume_group_name }}"
    pvs: "{{ target_device }}"
    state: present
  when: vg_strategy in ['create_new', 'extend_existing']

# === SIZE VALIDATION ===
- name: Get Volume Group information
  ansible.builtin.shell: |
    vgs --noheadings --units m --options vg_name,vg_size,vg_free "{{ volume_group_name }}" | \
    awk '{print "vg_name=" $1 ";vg_size_mb=" int($2) ";vg_free_mb=" int($3)}'
  register: vg_info
  changed_when: false
  failed_when: vg_info.rc != 0

- name: Parse VG information
  ansible.builtin.set_fact:
    vg_details: "{{ vg_info.stdout | regex_replace(';', '\n') | from_yaml }}"

- name: Calculate total requested LV size
  ansible.builtin.set_fact:
    total_requested_mb: "{{ filesystem_dirs | map(attribute='size_mb') | map('int') | sum }}"

- name: Debug Volume Group and LV size information
  ansible.builtin.debug:
    msg: |
      
      🔍 VOLUME GROUP SIZE ANALYSIS
      ============================
      Volume Group: {{ vg_details.vg_name }}
      Total VG Size: {{ vg_details.vg_size_mb }} MB
      Available Free Space: {{ vg_details.vg_free_mb }} MB
      
      📊 LOGICAL VOLUMES REQUESTED
      ============================
      {% for lv in filesystem_dirs %}
      - {{ lv.lv_name }}: {{ lv.size_mb }} MB ({{ lv.path }})
      {% endfor %}
      
      📈 SIZE SUMMARY
      ===============
      Total Requested: {{ total_requested_mb }} MB
      Available Space: {{ vg_details.vg_free_mb }} MB
      {% if total_requested_mb|int > vg_details.vg_free_mb|int %}
      ❌ INSUFFICIENT SPACE: Need {{ total_requested_mb|int - vg_details.vg_free_mb|int }} MB more!
      {% else %}
      ✅ SUFFICIENT SPACE: {{ vg_details.vg_free_mb|int - total_requested_mb|int }} MB will remain free
      {% endif %}

- name: Validate sufficient space for all LVs
  ansible.builtin.fail:
    msg: |
      ❌ INSUFFICIENT SPACE IN VOLUME GROUP!
      
      Volume Group '{{ volume_group_name }}' has only {{ vg_details.vg_free_mb }} MB free,
      but you requested {{ total_requested_mb }} MB total for logical volumes.
      
      You need {{ total_requested_mb|int - vg_details.vg_free_mb|int }} MB more space.
      
      Options:
      1. Reduce the size of logical volumes in your configuration
      2. Add more physical volumes to extend the volume group
      3. Use a larger disk/device
      
      Current LV requests:
      {% for lv in filesystem_dirs %}
      - {{ lv.lv_name }}: {{ lv.size_mb }} MB
      {% endfor %}
  when: total_requested_mb|int > vg_details.vg_free_mb|int

# === LOGICAL VOLUMES ===
- name: Create Logical Volumes
  community.general.lvol:
    vg: "{{ volume_group_name }}"
    lv: "{{ item.lv_name }}"
    size: "{{ item.size_mb }}m"
    state: present
  loop: "{{ filesystem_dirs }}"

# === FILESYSTEMS ===
- name: Create filesystems
  community.general.filesystem:
    fstype: "{{ item.fstype | default('xfs') }}"
    dev: "/dev/{{ volume_group_name }}/{{ item.lv_name }}"
    force: no
  loop: "{{ filesystem_dirs }}"

- name: Create mount directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0755') }}"
  loop: "{{ filesystem_dirs }}"

- name: Mount filesystems
  ansible.posix.mount:
    path: "{{ item.path }}"
    src: "/dev/{{ volume_group_name }}/{{ item.lv_name }}"
    fstype: "{{ item.fstype | default('xfs') }}"
    opts: "{{ item.mount_opts | default('defaults') }}"
    state: mounted
  loop: "{{ filesystem_dirs }}"

- name: Display summary
  ansible.builtin.include_tasks: summary.yml
