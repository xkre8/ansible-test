---
- name: Install LVM packages
  ansible.builtin.package:
    name: lvm2
    state: present


- name: Create Physical Volume and Volume Group
  ansible.builtin.shell: |
    if ! pvs {{ lvm_device }} --noheadings >/dev/null 2>&1; then
      pvcreate {{ lvm_device }}
    fi
    if ! vgs {{ volume_group_name }} --noheadings >/dev/null 2>&1; then
      vgcreate {{ volume_group_name }} {{ lvm_device }}
    fi
  register: pv_vg_result
  changed_when: "'already exists' not in pv_vg_result.stderr"

- name: Create Logical Volumes
  ansible.builtin.shell: |
    if ! lvs {{ volume_group_name }}/{{ item.lv_name | default(item.path | basename) }} --noheadings >/dev/null 2>&1; then
      lvcreate -L {{ item.size_mb }}M -n {{ item.lv_name | default(item.path | basename) }} {{ volume_group_name }}
    fi
  loop: "{{ filesystem_dirs }}"
  when: item.create_lvm | default(false)
  register: lv_result
  changed_when: "'already exists' not in lv_result.stderr"

- name: Create filesystems
  ansible.builtin.shell: |
    if ! blkid /dev/{{ volume_group_name }}/{{ item.lv_name | default(item.path | basename) }} >/dev/null 2>&1; then
      mkfs.{{ item.fstype | default('xfs') }} /dev/{{ volume_group_name }}/{{ item.lv_name | default(item.path | basename) }}
    fi
  loop: "{{ filesystem_dirs }}"
  when: item.create_lvm | default(false)
  register: mkfs_result
  changed_when: "'already has a' not in mkfs_result.stderr"


- name: Create mount directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0755') }}"
  loop: "{{ filesystem_dirs }}"


- name: Mount filesystems
  ansible.builtin.mount:
    path: "{{ item.path }}"
    src: "/dev/{{ volume_group_name }}/{{ item.lv_name | default(item.path | basename) }}"
    fstype: "{{ item.fstype | default('xfs') }}"
    opts: "{{ item.mount_opts | default('defaults') }}"
    state: mounted
  loop: "{{ filesystem_dirs }}"
  when: item.create_lvm | default(false)