---
# === VOLUME GROUP CREATION ===
- name: Display VG creation plan
  ansible.builtin.debug:
    msg: |
      üì¶ VOLUME GROUP CREATION PLAN:
      üéØ Primary VG: {{ volume_group_name }} on {{ primary_device }}
         ‚úÖ Will create: {{ create_primary_vg | default(true) }}
      {% if split_disk %}
      üéØ Secondary VG: {{ volume_group2_name }} on {{ secondary_device }}
         ‚úÖ Will create: {{ create_secondary_vg | default(false) }}
      {% endif %}

# === CREATE PRIMARY VG ===
- name: Create primary volume group
  community.general.lvg:
    vg: "{{ volume_group_name }}"
    pvs: "{{ primary_device }}"
    state: present
  register: primary_vg_result
  when: create_primary_vg | default(true)

- name: Get primary VG information
  ansible.builtin.command: vgs {{ volume_group_name }} --units m --noheadings -o vg_size,vg_free --nosuffix
  register: primary_vg_info
  changed_when: false
  when: create_primary_vg | default(true)

# === CREATE SECONDARY VG (if split_disk) ===
- name: Create secondary volume group
  community.general.lvg:
    vg: "{{ volume_group2_name }}"
    pvs: "{{ secondary_device }}"
    state: present
  register: secondary_vg_result
  when: 
    - split_disk
    - create_secondary_vg | default(false)
    - secondary_device != ""
    - volume_group2_name != ""

- name: Get secondary VG information
  ansible.builtin.command: vgs {{ volume_group2_name }} --units m --noheadings -o vg_size,vg_free --nosuffix
  register: secondary_vg_info
  changed_when: false
  when: 
    - split_disk
    - create_secondary_vg | default(false)
    - secondary_device != ""
    - volume_group2_name != ""

# === DISPLAY VG CREATION RESULTS ===
- name: Display VG creation results
  ansible.builtin.debug:
    msg: |
      ‚úÖ VOLUME GROUP CREATION COMPLETE:
      
      {% if create_primary_vg | default(true) %}
      üì¶ Primary VG: {{ volume_group_name }}
         Size: {{ primary_vg_info.stdout.split()[0] }}MB
         Free: {{ primary_vg_info.stdout.split()[1] }}MB
         Device: {{ primary_device }}
      {% else %}
      ‚ùå Primary VG: {{ volume_group_name }} - SKIPPED (insufficient space)
      {% endif %}
      
      {% if split_disk %}
        {% if create_secondary_vg | default(false) %}
      üì¶ Secondary VG: {{ volume_group2_name }}
         Size: {{ secondary_vg_info.stdout.split()[0] }}MB
         Free: {{ secondary_vg_info.stdout.split()[1] }}MB
         Device: {{ secondary_device }}
        {% else %}
      ‚ùå Secondary VG: {{ volume_group2_name }} - SKIPPED (insufficient space or no filesystems)
        {% endif %}
      {% endif %}