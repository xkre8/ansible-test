---
- name: "Debug parsed users"
  ansible.builtin.debug:
    var: users

- name: "Extract required groups safely"
  ansible.builtin.set_fact:
    gid_groups: "{{ users | selectattr('gid', 'defined') | selectattr('gid') | map(attribute='gid') | select('string') | select() | list }}"
    groupname_groups: "{{ users | selectattr('groupname', 'defined') | selectattr('groupname') | map(attribute='groupname') | select('string') | select() | list }}"
    additional_groups_flat: "{{ users | selectattr('additional_groups', 'defined') | map(attribute='additional_groups') | flatten | select('string') | list }}"

- name: "Combine all required groups"
  ansible.builtin.set_fact:
    all_required_groups: "{{ (gid_groups + groupname_groups + additional_groups_flat) | unique }}"

- name: "Check groups exist"
  ansible.builtin.command: getent group "{{ item }}"
  register: group_check
  failed_when: false
  changed_when: false
  loop: "{{ all_required_groups }}"
  when: all_required_groups | length > 0

- name: "Set missing_groups to empty list by default"
  ansible.builtin.set_fact:
    missing_groups: []

- name: "Identify missing groups"
  ansible.builtin.set_fact:
    missing_groups: "{{ group_check.results | selectattr('rc', '!=', 0) | map(attribute='item') | list }}"
  when: 
    - group_check is defined
    - group_check.results is defined

# *** เงื่อนไขใหม่ ***
- name: "Create missing groups if enabled"
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
  loop: "{{ missing_groups }}"
  when: 
    - create_missing_groups | bool
    - missing_groups | length > 0

- name: "Update missing groups list after creation"
  ansible.builtin.set_fact:
    missing_groups: []
  when: 
    - create_missing_groups | bool
    - missing_groups | length > 0

- name: "Fail if missing groups found and auto-creation disabled"
  ansible.builtin.fail:
    msg: |
      ❌ MISSING GROUPS DETECTED ❌
      Required: {{ all_required_groups | join(', ') }}
      Missing: {{ missing_groups | join(', ') }}
      
      Options:
      1. Create groups manually: sudo groupadd {{ missing_groups | join(' ') }}
      2. Enable auto-creation: create_missing_groups=true
  when: 
    - not (create_missing_groups | bool)
    - missing_groups is defined
    - missing_groups | length > 0