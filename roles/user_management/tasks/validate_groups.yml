---
- name: "Get all existing groups"
  ansible.builtin.getent:
    database: group
  register: all_groups_raw

- name: "Extract group names"
  ansible.builtin.set_fact:
    existing_groups: "{{ all_groups_raw.ansible_facts.getent_group.keys() | list }}"

- name: "Collect required groups from users"
  ansible.builtin.set_fact:
    required_groups: "{{ processed_users | map(attribute='groups') | flatten | unique | list }}"

- name: "Check if all required groups exist"
  ansible.builtin.set_fact:
    missing_groups: "{{ required_groups | difference(existing_groups) }}"

- name: "Create missing groups (if enabled)"
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
  loop: "{{ missing_groups }}"
  when: 
    - create_missing_groups | default(false)
    - missing_groups | length > 0

- name: "Fail if groups missing and auto-create disabled"
  ansible.builtin.fail:
    msg: |
      ❌ Missing groups: {{ missing_groups | join(', ') }}
      Set create_missing_groups: true to auto-create
  when: 
    - not (create_missing_groups | default(false))
    - missing_groups | length > 0