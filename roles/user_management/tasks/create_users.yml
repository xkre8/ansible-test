---
- name: "Create user accounts"
  ansible.builtin.user:
    name: "{{ item.name }}"
    password: "{{ item.password | password_hash('sha512') if item.password != '' else omit }}"
    uid: "{{ item.uid }}"
    group: "{{ item.group }}"
    groups: "{{ item.groups }}"
    home: "{{ item.home }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    state: present
    create_home: yes
  loop: "{{ processed_users }}"
  loop_control:
    label: "{{ item.name }}"
  register: user_creation_result
  failed_when: false  # 🔥 ไม่หยุดถ้า fail

# 🔥 แสดงรายการ user ที่ fail
- name: "Display failed users"
  ansible.builtin.debug:
    msg: "❌ Failed to create: {{ item.item.name }} - {{ item.msg }}"
  loop: "{{ user_creation_result.results }}"
  when: item.failed | default(false)
  loop_control:
    label: "{{ item.item.name }}"

# 🔥 สรุปผลลัพธ์
- name: "Display creation summary"
  ansible.builtin.debug:
    msg: |
      ✅ User Creation Summary:
      ├─ Total: {{ processed_users | length }}
      ├─ Created: {{ user_creation_result.results | selectattr('changed') | list | length }}
      ├─ Skipped: {{ user_creation_result.results | rejectattr('changed') | rejectattr('failed', 'defined') | list | length }}
      └─ Failed: {{ user_creation_result.results | selectattr('failed', 'defined') | list | length }}