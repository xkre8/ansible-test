---
- name: "Process user data"
  ansible.builtin.set_fact:
    processed_users: "{{ processed_users | default([]) + [user_data] }}"
  vars:
    # ใช้ default() แทน or 
    random_username: "user_{{ ansible_date_time.epoch }}_{{ 999999 | random }}"
    random_uid: "{{ range(uid_min, uid_max) | random }}"
    random_password: "{{ lookup('password', '/dev/null length=' + password_length|string + ' chars=ascii_letters,digits,!@#$%^&*') }}"

    #
    final_username: "{{ item.username | default('') }}"
    final_uid: "{{ item.uid | default('') }}"
    final_gid: "{{ item.gid | default('') }}"
    final_password: "{{ item.password | default('') }}"
    final_home_dir: "{{ item.home_directory | default('') }}"
    final_groupname: "{{ item.groupname | default('') }}"
    final_description: "{{ item.description | default('') }}"
    final_purpose: "{{ item.purpose | default('') }}"                   
    
    # Auto-generate description จาก SR info + purpose
    auto_sr_description: "{{ item.auto_description | default('') }}"
    purpose_suffix: "{{ (' - ' + final_purpose) if final_purpose != '' else '' }}"   
    final_comment: "{{ final_description if final_description != '' else (auto_sr_description + purpose_suffix if auto_sr_description != '' else 'Managed by Ansible') }}"
    
    user_data:
      name: "{{ final_username if final_username != '' else random_username }}"
      uid: "{{ final_uid if final_uid != '' else random_uid }}"
      group: "{{ final_gid if final_gid != '' else 'users' }}"
      password: "{{ final_password if final_password != '' else random_password }}"
      home: "{{ (final_home_dir if final_home_dir != '' else home_base_path) + '/' + (final_username if final_username != '' else random_username) }}"
      shell: "{{ item.shell | default(os_shell) }}"
      groups: "{{ ([final_groupname] if final_groupname != '' else []) + (item.additional_groups | default([])) }}"
      comment: "{{ final_comment }}"
      sr_number: "{{ item.sr_info.sr_number | default('') }}"
      owner_name: "{{ item.sr_info.owner_name | default('') }}"
      tel: "{{ item.sr_info.tel | default('') }}"
      purpose: "{{ final_purpose }}"                                     
      # Track what was generated
      random_password: "{{ final_password == '' }}"
      random_uid: "{{ final_uid == '' }}"
      random_username: "{{ final_username == '' }}"
  loop: "{{ users }}"
  when: users | length > 0

- name: "Create users"
  ansible.builtin.user:
    name: "{{ item.name }}"
    uid: "{{ item.uid }}"
    group: "{{ item.group }}"
    groups: "{{ item.groups | join(',') if item.groups | length > 0 else omit }}"   
    password: "{{ item.password | password_hash('sha512') }}"
    home: "{{ item.home }}"
    shell: "{{ item.shell }}"
    comment: "{{ item.comment }}"
    create_home: yes
    state: present
  loop: "{{ processed_users | default([]) }}"