---
- name: "Create user accounts"
  ansible.builtin.user:
    name: "{{ item.name }}"
    password: "{{ item.password | password_hash('sha512') if item.password != '' else omit }}"
    uid: "{{ item.uid }}"
    group: "{{ item.group }}"
    groups: "{{ item.groups }}"
    home: "{{ item.home }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    state: present
    create_home: yes
  loop: "{{ processed_users }}"
  loop_control:
    label: "{{ item.name }}"
  register: user_creation_result
  failed_when: false  # ğŸ”¥ à¹„à¸¡à¹ˆà¸«à¸¢à¸¸à¸”à¸–à¹‰à¸² fail

# ğŸ”¥ à¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¸à¸²à¸£ user à¸—à¸µà¹ˆ fail
- name: "Display failed users"
  ansible.builtin.debug:
    msg: "âŒ Failed to create: {{ item.item.name }} - {{ item.msg }}"
  loop: "{{ user_creation_result.results }}"
  when: item.failed | default(false)
  loop_control:
    label: "{{ item.item.name }}"

# ğŸ”¥ à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
- name: "Display creation summary"
  ansible.builtin.debug:
    msg: |
      âœ… User Creation Summary:
      â”œâ”€ Total: {{ processed_users | length }}
      â”œâ”€ Created: {{ user_creation_result.results | selectattr('changed') | list | length }}
      â”œâ”€ Skipped: {{ user_creation_result.results | rejectattr('changed') | rejectattr('failed', 'defined') | list | length }}
      â””â”€ Failed: {{ user_creation_result.results | selectattr('failed', 'defined') | list | length }}