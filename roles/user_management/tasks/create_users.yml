# ---
# - name: "Process user data"
#   ansible.builtin.set_fact:
#     processed_users: "{{ processed_users | default([]) + [user_data] }}"
#   vars:
#     user_data:
#       name: "{{ item.username or ('user_' + ansible_date_time.epoch + '_' + (999999 | random | string)) }}"
#       uid: "{{ item.uid or (1000 if not item.gid else (range(uid_min, uid_max) | random)) }}"
#       group: "{{ item.gid or 'users' }}"
#       password: "{{ item.password or lookup('password', '/dev/null length=' + password_length|string) }}"
#       home: "{{ (item.home_directory or '/home') + '/' + (item.username or ('user_' + ansible_date_time.epoch)) }}"
#       shell: "{{ item.shell | default(os_shell) }}"
#       groups: "{{ ([item.groupname] if item.groupname else []) + (item.additional_groups | default([])) }}"
#       random_password: "{{ not item.password }}"
#       random_uid: "{{ not item.uid }}"
#   loop: "{{ users }}"
#   when: users | length > 0

# - name: "Create users"
#   ansible.builtin.user:
#     name: "{{ item.name }}"
#     uid: "{{ item.uid }}"
#     group: "{{ item.group }}"
#     groups: "{{ item.groups | join(',') if item.groups else omit }}"
#     password: "{{ item.password | password_hash('sha512') }}"
#     home: "{{ item.home }}"
#     shell: "{{ item.shell }}"
#     create_home: yes
#     state: present
#   loop: "{{ processed_users | default([]) }}"

---
- name: "Process user data"
  ansible.builtin.set_fact:
    processed_users: "{{ processed_users | default([]) + [user_data] }}"
  vars:
    # ใช้ default() แทน or เพื่อความปลอดภัย
    random_username: "user_{{ ansible_date_time.epoch }}_{{ 999999 | random }}"
    random_uid: "{{ range(uid_min, uid_max) | random }}"
    random_password: "{{ lookup('password', '/dev/null length=' + password_length|string + ' chars=ascii_letters,digits') }}"
    
    # ตรวจสอบและกำหนดค่าอย่างปลอดภัย
    final_username: "{{ item.username | default('') }}"
    final_uid: "{{ item.uid | default('') }}"
    final_gid: "{{ item.gid | default('') }}"
    final_password: "{{ item.password | default('') }}"
    final_home_dir: "{{ item.home_directory | default('') }}"
    final_groupname: "{{ item.groupname | default('') }}"
    
    user_data:
      name: "{{ final_username if final_username != '' else random_username }}"
      # *** LOGIC ใหม่ ***
      uid: "{{ final_uid if final_uid != '' else random_uid }}"
      group: "{{ final_gid if final_gid != '' else 'users' }}"
      # *** จบ LOGIC ใหม่ ***
      password: "{{ final_password if final_password != '' else random_password }}"
      home: "{{ (final_home_dir if final_home_dir != '' else home_base_path) + '/' + (final_username if final_username != '' else random_username) }}"
      shell: "{{ item.shell | default(os_shell) }}"
      groups: "{{ ([final_groupname] if final_groupname != '' else []) + (item.additional_groups | default([])) }}"
      # Track what was generated
      random_password: "{{ final_password == '' }}"
      random_uid: "{{ final_uid == '' }}"
      random_username: "{{ final_username == '' }}"
  loop: "{{ users }}"
  when: users | length > 0

- name: "Create users"
  ansible.builtin.user:
    name: "{{ item.name }}"
    uid: "{{ item.uid }}"
    group: "{{ item.group }}"
    groups: "{{ item.groups | join(',') if item.groups | length > 0 else omit }}"
    password: "{{ item.password | password_hash('sha512') }}"
    home: "{{ item.home }}"
    shell: "{{ item.shell }}"
    create_home: yes
    state: present
  loop: "{{ processed_users | default([]) }}"