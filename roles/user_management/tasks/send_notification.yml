---
- name: "Group users by email for notification"
  ansible.builtin.set_fact:
    email_groups: >-
      {%- set result = {} -%}
      {%- for user in processed_users | default([]) -%}
        {%- if user.email != '' -%}
          {%- if user.email not in result -%}
            {%- set _ = result.update({user.email: []}) -%}
          {%- endif -%}
          {%- set _ = result[user.email].append(user) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ result }}
  when: 
    - send_email_notification | bool
    - processed_users is defined

- name: "Debug email groups"
  ansible.builtin.debug:
    msg: |
      Email groups: {{ email_groups | length if email_groups is defined else 0 }}
      {% if email_groups is defined and email_groups | length > 0 %}
      {% for email, users in email_groups.items() %}
      - {{ email }}: {{ users | length }} users
      {% endfor %}
      {% endif %}
  when: 
    - send_email_notification | bool
    - email_groups is defined

# à¹€à¸žà¸´à¹ˆà¸¡ task à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š mail commands (à¹à¸à¹‰à¹„à¸‚ condition)
- name: "Check available mail commands"
  ansible.builtin.shell: |
    if command -v /usr/sbin/sendmail >/dev/null 2>&1; then
      echo "sendmail"
    elif command -v sendmail >/dev/null 2>&1; then
      echo "sendmail"
    elif command -v /usr/bin/mail >/dev/null 2>&1; then
      echo "mail"
    elif command -v mail >/dev/null 2>&1; then
      echo "mail"
    else
      echo "none"
    fi
  register: mail_command_check
  changed_when: false
  when: 
    - send_email_notification | bool
    - email_groups is defined
    - email_groups | length > 0  # à¹à¸à¹‰à¹„à¸‚à¸•à¸£à¸‡à¸™à¸µà¹‰

- name: "Debug mail command detection"
  ansible.builtin.debug:
    msg: "Detected mail command: {{ mail_command_check.stdout }}"
  when: 
    - send_email_notification | bool
    - mail_command_check is defined

- name: "Create email body for each SR"
  ansible.builtin.copy:
    dest: "/tmp/email_{{ item.value[0].sr_number }}.txt"
    content: |
      Dear {{ item.value[0].owner_name }},
      
      Your user account creation request ({{ item.value[0].sr_number }}) has been completed successfully.
      
      ðŸ“‹ Service Request Details:
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      SR Number: {{ item.value[0].sr_number }}
      Requester: {{ item.value[0].owner_name }}
      Contact: {{ item.value[0].tel }}
      Email: {{ item.key }}
      Completion Date: {{ ansible_date_time.date }}
      
      ðŸ‘¥ Created Users ({{ item.value | length }} users):
      {% for user in item.value %}
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ðŸ‘¤ Username: {{ user.name }}
         â”œâ”€â”€ UID: {{ user.uid }}{% if user.random_uid %} (Auto-generated){% endif %}
         â”œâ”€â”€ Purpose: {{ user.purpose | default('Not specified') }}
         â”œâ”€â”€ Primary Group: {{ user.group }}
         â”œâ”€â”€ Additional Groups: {{ user.groups | join(', ') if user.groups | length > 0 else 'None' }}
         â”œâ”€â”€ Home Directory: {{ user.home }}
         â”œâ”€â”€ Shell: {{ user.shell }}
         â””â”€â”€ Password: {% if user.random_password %}{{ user.password }} âš ï¸ SAVE THIS SECURELY!{% else %}As provided by requester{% endif %}
      
      {% endfor %}
      ðŸ”’ Important Security Notes:
      â€¢ Please change auto-generated passwords on first login
      â€¢ Follow company security policies for password management
      â€¢ Users must acknowledge receipt of this information
      â€¢ Report any issues to IT Support immediately
      
      This notification was sent automatically by Ansible Automation Platform.
      
      Best regards,
      IT Automation Team
      Company Infrastructure Department
    mode: '0644'
  loop: "{{ email_groups | dict2items }}"
  delegate_to: localhost
  when: 
    - send_email_notification | bool
    - email_groups is defined
    - email_groups | length > 0
    - mail_command_check is defined

# à¹ƒà¸Šà¹‰ sendmail à¸–à¹‰à¸²à¸žà¸š
- name: "Send email using sendmail"
  ansible.builtin.shell: |
    (
      echo "Subject: {{ email_subject_prefix | default('[Ansible]') }} - {{ item.value[0].sr_number }}"
      echo "To: {{ item.key }}"
      echo "From: {{ email_from | default('ansible@company.com') }}"
      echo "Content-Type: text/plain; charset=UTF-8"
      echo ""
      cat "/tmp/email_{{ item.value[0].sr_number }}.txt"
    ) | /usr/sbin/sendmail -t
  loop: "{{ email_groups | dict2items }}"
  when: 
    - send_email_notification | bool
    - email_groups is defined
    - email_groups | length > 0
    - mail_command_check is defined
    - mail_command_check.stdout == 'sendmail'
  register: sendmail_result

# à¹ƒà¸Šà¹‰ mail command à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ sendmail
- name: "Send email using mail command"
  ansible.builtin.shell: |
    cat "/tmp/email_{{ item.value[0].sr_number }}.txt" | /usr/bin/mail -s "{{ email_subject_prefix | default('[Ansible]') }} - {{ item.value[0].sr_number }}" "{{ item.key }}"
  loop: "{{ email_groups | dict2items }}"
  when: 
    - send_email_notification | bool
    - email_groups is defined
    - email_groups | length > 0
    - mail_command_check is defined
    - mail_command_check.stdout == 'mail'
  register: mail_result

# à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ mail command
- name: "Skip email - no mail command available"
  ansible.builtin.debug:
    msg: "âš ï¸ No mail command available (sendmail, mail). Skipping email notification."
  when: 
    - send_email_notification | bool
    - email_groups is defined
    - email_groups | length > 0
    - mail_command_check is defined
    - mail_command_check.stdout == 'none'

- name: "Clean up email files"
  ansible.builtin.file:
    path: "/tmp/email_{{ item.value[0].sr_number }}.txt"
    state: absent
  loop: "{{ email_groups | dict2items }}"
  delegate_to: localhost
  when: 
    - send_email_notification | bool
    - email_groups is defined
    - email_groups | length > 0

# à¹à¸à¹‰à¹„à¸‚ summary (à¸¥à¸š .rc à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰ error)
- name: "Display email notification summary"
  ansible.builtin.debug:
    msg: |
      
      ðŸ“§ === EMAIL NOTIFICATION SUMMARY === ðŸ“§
      
      {% if send_email_notification | bool %}
      Mail command detected: {{ mail_command_check.stdout if mail_command_check is defined else 'not checked' }}
      Email groups found: {{ email_groups | length if email_groups is defined else 0 }}
      
      {% if email_groups is defined and email_groups | length > 0 %}
      Recipients:
      {% for email, users in email_groups.items() %}
      âœ… {{ email }} ({{ users[0].sr_number }}) - {{ users | length }} users created
      {% endfor %}
      
      {% if sendmail_result is defined %}
      Sendmail Results: {{ sendmail_result.results | length }} emails processed
      {% elif mail_result is defined %}
      Mail Results: {{ mail_result.results | length }} emails processed  
      {% else %}
      No emails sent (conditions not met)
      {% endif %}
      {% else %}
      No email groups to process
      {% endif %}
      {% else %}
      ðŸ“´ Email notifications disabled (send_email_notification: false)
      {% endif %}
  when: processed_users is defined