---
- name: "Group users by email for notification"
  ansible.builtin.set_fact:
    email_groups: >-
      {%- set result = {} -%}
      {%- for user in processed_users | default([]) -%}
        {%- if user.email != '' -%}
          {%- if user.email not in result -%}
            {%- set _ = result.update({user.email: []}) -%}
          {%- endif -%}
          {%- set _ = result[user.email].append(user) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ result }}
  when: 
    - send_email_notification | bool
    - processed_users is defined

- name: "Send email notification for each SR"
  community.general.mail:
    to: "{{ item.key }}"
    from: "{{ email_from | default('ansible@company.com') }}"
    subject: "{{ email_subject_prefix | default('[Ansible]') }} - {{ item.value[0].sr_number }}"
    body: "{{ email_body }}"
    host: "{{ smtp_host | default('localhost') }}"
    port: "{{ smtp_port | default(25) }}"
    username: "{{ smtp_username | default(omit) }}"
    password: "{{ smtp_password | default(omit) }}"
    secure: "{{ 'starttls' if smtp_port == 587 else 'never' }}"
  vars:
    email_body: |
      Dear {{ item.value[0].owner_name }},
      
      Your user account creation request ({{ item.value[0].sr_number }}) has been completed successfully.
      
      ğŸ“‹ Service Request Details:
      SR Number: {{ item.value[0].sr_number }}
      Requester: {{ item.value[0].owner_name }}
      Contact: {{ item.value[0].tel }}
      Email: {{ item.key }}
      
      ğŸ‘¥ Created Users:
      {% for user in item.value %}
      ğŸ‘¤ {{ user.name }} ({{ user.purpose | default('Not specified') }})
         Password: {% if user.random_password %}{{ user.password }} âš ï¸ SAVE THIS!{% else %}As provided{% endif %}
      {% endfor %}
      
      Best regards,
      IT Automation Team
  loop: "{{ email_groups | dict2items }}"
  when: 
    - send_email_notification | bool
    - email_groups is defined
    - email_groups | length > 0
  register: mail_result
  delegate_to: localhost

- name: "Display email notification summary"
  ansible.builtin.debug:
    msg: |
      
      ğŸ“§ === EMAIL NOTIFICATION SUMMARY === ğŸ“§
      
      {% if send_email_notification | bool %}
      Email notifications sent: {{ email_groups | length if email_groups is defined else 0 }}
      
      {% if email_groups is defined and email_groups | length > 0 %}
      Recipients:
      {% for email, users in email_groups.items() %}
      âœ… {{ email }} ({{ users[0].sr_number }}) - {{ users | length }} users created
      {% endfor %}
      
      {% if mail_result is defined and mail_result.results is defined %}
      Mail Results:
      {% for result in mail_result.results %}
      {% if result.failed is defined and not result.failed %}
      âœ… Email sent successfully to {{ result.item.key }}
      {% else %}
      âŒ Email failed to {{ result.item.key }}: {{ result.msg | default('Unknown error') }}
      {% endif %}
      {% endfor %}
      {% endif %}
      {% else %}
      No email groups to process
      {% endif %}
      {% else %}
      ğŸ“´ Email notifications disabled (send_email_notification: false)
      {% endif %}
  when: processed_users is defined