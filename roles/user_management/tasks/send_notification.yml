---
- name: "Group users by email for notification"
  ansible.builtin.set_fact:
    email_groups: >-
      {%- set result = {} -%}
      {%- for user in processed_users | default([]) -%}
        {%- if user.email != '' -%}
          {%- if user.email not in result -%}
            {%- set _ = result.update({user.email: []}) -%}
          {%- endif -%}
          {%- set _ = result[user.email].append(user) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ result }}
  when: 
    - send_email_notification | bool
    - processed_users is defined

- name: "Send email notification using sendmail"
  ansible.builtin.shell: |
    cat << 'EOF' | /usr/sbin/sendmail -t
    Subject: {{ email_subject_prefix | default('[Ansible]') }} User Account Created - {{ item.value[0].sr_number }}
    To: {{ item.key }}
    From: {{ email_from | default('ansible@company.com') }}
    Content-Type: text/plain; charset=UTF-8
    
    Dear {{ item.value[0].owner_name }},
    
    Your user account creation request ({{ item.value[0].sr_number }}) has been completed successfully.
    
    ğŸ“‹ Service Request Details:
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SR Number: {{ item.value[0].sr_number }}
    Requester: {{ item.value[0].owner_name }}
    Contact: {{ item.value[0].tel }}
    Email: {{ item.key }}
    Completion Date: {{ ansible_date_time.date }}
    
    ğŸ‘¥ Created Users ({{ item.value | length }} users):
    {% for user in item.value %}
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ğŸ‘¤ Username: {{ user.name }}
       â”œâ”€â”€ UID: {{ user.uid }}{% if user.random_uid %} (Auto-generated){% endif %}
       â”œâ”€â”€ Purpose: {{ user.purpose if user.purpose != '' else 'Not specified' }}
       â”œâ”€â”€ Primary Group: {{ user.group }}
       â”œâ”€â”€ Additional Groups: {{ user.groups | join(', ') if user.groups | length > 0 else 'None' }}
       â”œâ”€â”€ Home Directory: {{ user.home }}
       â”œâ”€â”€ Shell: {{ user.shell }}
       â””â”€â”€ Password: {% if user.random_password %}{{ user.password }} âš ï¸ SAVE THIS SECURELY!{% else %}As provided by requester{% endif %}
    
    {% endfor %}
    
    ğŸ”’ Important Security Notes:
    â€¢ Please change auto-generated passwords on first login
    â€¢ Follow company security policies for password management
    â€¢ Users must acknowledge receipt of this information
    â€¢ Report any issues to IT Support immediately
    
    Best regards,
    IT Automation Team
    EOF
  loop: "{{ email_groups | dict2items }}"
  when: 
    - send_email_notification | bool
    - email_groups is defined
    - email_groups | length > 0
  register: sendmail_result

- name: "Display email notification summary"
  ansible.builtin.debug:
    msg: |
      
      ğŸ“§ === EMAIL NOTIFICATION SUMMARY === ğŸ“§
      
      {% if send_email_notification | bool %}
      Email notifications sent: {{ email_groups | length if email_groups is defined else 0 }}
      
      Recipients:
      {% for email, users in (email_groups | default({})).items() %}
      âœ… {{ email }} ({{ users[0].sr_number }}) - {{ users | length }} users created
      {% endfor %}
      
      Sendmail Results:
      {% for result in sendmail_result.results | default([]) %}
      {% if result.rc == 0 %}
      âœ… Email sent successfully
      {% else %}
      âŒ Email failed: {{ result.stderr }}
      {% endif %}
      {% endfor %}
      {% else %}
      ğŸ“´ Email notifications disabled (send_email_notification: false)
      {% endif %}
  when: processed_users is defined