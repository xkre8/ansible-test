---
- name: "Get complete timezone info"
  ansible.builtin.set_fact:
    thailand_full_time: "{{ lookup('pipe', 'TZ=Asia/Bangkok date +\"%Y-%m-%d %H:%M:%S %Z (UTC%z)\"') }}"
  when: send_email_notification | bool


- name: "Group users by email for notification"
  ansible.builtin.set_fact:
    email_groups: >-
      {%- set result = {} -%}
      {%- for user in processed_users | default([]) -%}
        {%- if user.email != '' -%}
          {%- if user.email not in result -%}
            {%- set _ = result.update({user.email: []}) -%}
          {%- endif -%}
          {%- set _ = result[user.email].append(user) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ result }}
  when: 
    - send_email_notification | bool
    - processed_users is defined

- name: "Send email notification for each SR"
  community.general.mail:
    to: "{{ item.key }}"
    from: "{{ email_from | default('it-automation@company.com') }}"
    subject: "{{ email_subject_prefix | default('[IT Automation]') }} Account Creation Report - {{ item.value[0].sr_number }} [{{ thailand_date }}]"
    body: "{{ email_body }}"
    host: "{{ smtp_host | default('localhost') }}"
    port: "{{ smtp_port | default(25) }}"
    username: "{{ smtp_username | default(omit) }}"
    password: "{{ smtp_password | default(omit) }}"
    secure: "{{ 'starttls' if smtp_port == 587 else 'never' }}"
  vars:
    email_body: |
      Dear {{ item.value[0].owner_name }},
      
      Your user account creation request SR{{ item.value[0].sr_number }} has been successfully completed.
      
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ“‹ SERVICE REQUEST SUMMARY
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      SR Number    : {{ item.value[0].sr_number }}
      Requester    : {{ item.value[0].owner_name }}
      Contact      : {{ item.value[0].tel }}
      Email        : {{ item.key }}
      Completed At : {{ thailand_datetime }} (ICT)
      
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ‘¥ USER ACCOUNTS CREATED
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      {% for user in item.value %}
      Username : {{ user.name }}
        Purpose : {{ user.purpose | default('Not specified') }}
        Home    : {{ user.home_directory | default('/home/' + user.name) }}
        Groups  : {{ (user.additional_groups | join(', ')) if user.additional_groups is defined else 'N/A' }}
        Password: {% if user.random_password %}{{ user.password }}   âš ï¸ Please store this securely.{% else %}As provided{% endif %}
      {% if not loop.last %}

      {% endif %}
      {% endfor %}
      
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      âœ… STATUS : Completed Successfully
      ğŸ• Timestamp: {{ thailand_datetime }} (GMT+7)
      
      Thank you,
      IT Automation Team
      Company Infrastructure Operations
      
      ---------------------------------------------------------------------
      This is an automated message. Please do not reply to this email.
      Generated on: {{ thailand_date }} at {{ thailand_time }} ICT
  loop: "{{ email_groups | dict2items }}"
  when:
    - send_email_notification | bool
    - email_groups is defined
    - email_groups | length > 0
  register: mail_result
  delegate_to: localhost

- name: "Display notification summary"
  ansible.builtin.debug:
    msg: |
      ğŸ“§ EMAIL NOTIFICATION SUMMARY:
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ• Sent at: {{ thailand_datetime }} (ICT)
      ğŸ“Š Total emails sent: {{ email_groups | length }}
      
      Recipients:
      {% for email in email_groups.keys() %}
        âœ‰ï¸  {{ email }} ({{ email_groups[email] | length }} user(s))
      {% endfor %}
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  when:
    - send_email_notification | bool
    - mail_result is defined