---
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# USER MANAGEMENT V2 - MAIN ORCHESTRATOR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: "ğŸ“¢ Display role information"
  ansible.builtin.debug:
    msg: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘   USER MANAGEMENT V2 - CLEAN CODE EDITION            â•‘
      â•‘   Version: {{ user_management_version }}              â•‘
      â•‘   Mode: {{ 'DRY-RUN' if dry_run else 'PRODUCTION' }} â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  when: debug_mode | bool

- name: "ğŸ“¦ Install required packages"
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop: "{{ required_packages }}"
  when: not dry_run

- name: "ğŸ” PHASE 1: Input Validation"
  ansible.builtin.include_tasks: validate.yml
  tags:
    - validation
    - always

- name: "ğŸ”§ PHASE 2: Data Transformation"
  ansible.builtin.include_tasks: transform.yml
  tags:
    - transform
    - always

- name: "ğŸ‘¤ PHASE 3: User Creation"
  block:
    - name: Create users
      ansible.builtin.include_tasks: create_users.yml
  rescue:
    - name: Handle user creation errors
      ansible.builtin.debug:
        msg: "âš ï¸ User creation encountered errors. Check rollback option."
    
    - name: Execute rollback if enabled
      ansible.builtin.include_tasks: rollback.yml
      when: enable_rollback_on_error | bool
  tags:
    - users

- name: "ğŸ“Š PHASE 4: Generate Report"
  ansible.builtin.include_tasks: report.yml
  tags:
    - report

- name: "ğŸ“§ PHASE 5: Send Notifications"
  ansible.builtin.include_tasks: notify.yml
  when: enable_email_notification | bool
  tags:
    - notification

- name: "ğŸ“ PHASE 6: Audit Logging"
  ansible.builtin.include_tasks: audit.yml
  when: enable_audit_logging | bool
  tags:
    - audit

- name: "âœ… Role execution completed"
  ansible.builtin.debug:
    msg: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘   âœ… USER MANAGEMENT COMPLETED SUCCESSFULLY          â•‘
      â•‘   Users processed: {{ processed_users | length }}    â•‘
      â•‘   Time: {{ ansible_date_time.iso8601 }}              â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
