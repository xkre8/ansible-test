---
# ═══════════════════════════════════════════════════════════
# REPORT GENERATION
# ═══════════════════════════════════════════════════════════

- name: "Get Thailand time for report"
  ansible.builtin.set_fact:
    report_timestamp: "{{ lookup('pipe', 'TZ=' + timezone + ' date +\"%Y-%m-%d %H:%M:%S\"') }}"
  when: use_thailand_timezone | bool

- name: "Generate text report"
  ansible.builtin.set_fact:
    user_report: |
      ═══════════════════════════════════════════════════════
      📊 USER CREATION REPORT
      ═══════════════════════════════════════════════════════
      Generated: {{ report_timestamp | default(ansible_date_time.iso8601) }}
      Mode: {{ 'DRY-RUN' if dry_run else 'PRODUCTION' }}
      
      {% if not dry_run %}
      Summary:
      ├─ Total users: {{ processed_users | length }}
      ├─ Created: {{ created_users | default([]) | length }}
      ├─ Skipped: {{ skipped_users | default([]) | length }}
      └─ Failed: {{ failed_users | default([]) | length }}
      {% else %}
      Total users to create: {{ processed_users | length }}
      {% endif %}
      
      ───────────────────────────────────────────────────────
      {% for user in processed_users %}
      {{ loop.index }}. Username: {{ user.name }}
         UID: {{ user.uid | default('auto-assigned') }}
         Home: {{ user.home_directory }}
         Shell: {{ user.shell }}
         Groups: {{ user.groups | join(', ') if user.groups else 'N/A' }}
         Password: {{ '🔐 Auto-generated' if user.random_password else '✅ User-provided' }}
         Email: {{ user.email if user.email != '' else 'N/A' }}
         SR: {{ user.sr_number }}
         Purpose: {{ user.purpose }}
      {% if not loop.last %}
      
      {% endif %}
      {% endfor %}
      ═══════════════════════════════════════════════════════

- name: "Display report"
  ansible.builtin.debug:
    msg: "{{ user_report }}"

- name: "Create report directory"
  ansible.builtin.file:
    path: "{{ report_directory }}"
    state: directory
    mode: '0755'
  when:
    - save_report_to_file | bool
    - not dry_run

- name: "Save report to file"
  ansible.builtin.copy:
    content: "{{ user_report }}"
    dest: "{{ report_directory }}/user_creation_{{ ansible_date_time.epoch }}.txt"
    mode: '0644'
  register: report_file
  when:
    - save_report_to_file | bool
    - not dry_run

- name: "Display report file location"
  ansible.builtin.debug:
    msg: "📄 Report saved to: {{ report_file.dest }}"
  when:
    - save_report_to_file | bool
    - not dry_run
    - report_file is defined
