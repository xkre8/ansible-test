---
# ===============================================
# LVM MANAGEMENT ROLE - TEST SCENARIOS
# ===============================================
# File: test_scenarios.yml
# Description: Complete test cases for LVM role covering all scenarios

# ===============================================
# üü¢ PASS SCENARIOS
# ===============================================

# ------------------ SCENARIO 1: CREATE PARTITION ------------------
- name: "PASS-1: Create Partition Strategy"
  hosts: test_servers
  vars:
    # Survey Variables
    partition_strategy: "create_partition"
    partition_size_gb: 5
    selected_disk_name: "sdc"
    pv_strategy: "create_new_pv"
    vg_strategy: "create_new"
    volume_group_name: "vg_app"
    filesystem_config: |
      - path: "/app"
        lv_name: "app_lv"
        size_mb: 2048
        fstype: "xfs"
      - path: "/logs"
        lv_name: "logs_lv"
        size_mb: 1024
        fstype: "ext4"
  roles:
    - lvm_management
  # Expected Result:
  # ‚úÖ Create 5GB partition on /dev/sdc
  # ‚úÖ PV: /dev/sdc1 (5GB)
  # ‚úÖ VG: vg_app (5GB, 2GB free)
  # ‚úÖ LV: app_lv (2GB XFS), logs_lv (1GB EXT4)
  # ‚úÖ Mounted: /app, /logs

# ------------------ SCENARIO 2: USE WHOLE DISK ------------------
- name: "PASS-2: Use Whole Disk Strategy"
  hosts: test_servers
  vars:
    partition_strategy: "use_whole_disk"
    selected_disk_name: "sdd"
    pv_strategy: "create_new_pv"
    vg_strategy: "create_new"
    volume_group_name: "vg_data"
    filesystem_config: |
      - path: "/data"
        lv_name: "data_lv"
        size_mb: 8192
        fstype: "xfs"
      - path: "/backup"
        lv_name: "backup_lv"
        size_mb: 1024
        fstype: "ext4"
  roles:
    - lvm_management
  # Expected Result:
  # ‚úÖ Use whole disk /dev/sdd (10GB)
  # ‚úÖ PV: /dev/sdd (10GB)
  # ‚úÖ VG: vg_data (10GB, 1GB free)
  # ‚úÖ LV: data_lv (8GB XFS), backup_lv (1GB EXT4)

# ------------------ SCENARIO 3: USE EXISTING PV ------------------
- name: "PASS-3: Use Existing PV"
  hosts: test_servers
  vars:
    partition_strategy: "use_whole_disk"  # ‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
    pv_strategy: "use_existing_pv"
    existing_pv_device: "/dev/sda4"
    vg_strategy: "extend_existing"
    volume_group_name: "rootvg"
    filesystem_config: |
      - path: "/opt"
        lv_name: "opt_lv"
        size_mb: 5120
        fstype: "xfs"
  roles:
    - lvm_management
  # Expected Result:
  # ‚úÖ Use existing PV: /dev/sda4
  # ‚úÖ Extend existing VG: rootvg
  # ‚úÖ LV: opt_lv (5GB XFS)

# ------------------ SCENARIO 4: AUTO-GENERATE LV NAMES ------------------
- name: "PASS-4: Auto-Generate LV Names"
  hosts: test_servers
  vars:
    partition_strategy: "create_partition"
    partition_size_gb: 3
    selected_disk_name: "sde"
    pv_strategy: "create_new_pv"
    vg_strategy: "create_new"
    volume_group_name: "vg_auto"
    filesystem_config: |
      - path: "/var/www"
        # lv_name: ""  # ‡∏à‡∏∞ auto-generate ‡πÄ‡∏õ‡πá‡∏ô vg_auto_var_www
        size_mb: 2048
        fstype: "xfs"
      - path: "/home/user"
        # lv_name: ""  # ‡∏à‡∏∞ auto-generate ‡πÄ‡∏õ‡πá‡∏ô vg_auto_home_user
        size_mb: 512
        fstype: "ext4"
  roles:
    - lvm_management
  # Expected Result:
  # ‚úÖ Auto LV names: vg_auto_var_www, vg_auto_home_user

# ------------------ SCENARIO 5: MAXIMUM SIZE USAGE ------------------
- name: "PASS-5: Maximum Size Usage (Edge Case)"
  hosts: test_servers
  vars:
    partition_strategy: "create_partition"
    partition_size_gb: 2
    selected_disk_name: "sdf"
    pv_strategy: "create_new_pv"
    vg_strategy: "create_new"
    volume_group_name: "vg_edge"
    filesystem_config: |
      - path: "/test"
        lv_name: "test_lv"
        size_mb: 1900  # ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏° 2GB partition
        fstype: "xfs"
  roles:
    - lvm_management
  # Expected Result:
  # ‚úÖ Near-full usage (1.9GB / 2GB)

# ===============================================
# üî¥ ERROR SCENARIOS
# ===============================================

# ------------------ ERROR 1: SIZE EXCEEDED ------------------
- name: "ERROR-1: Total Size Exceeds VG Capacity"
  hosts: test_servers
  vars:
    partition_strategy: "create_partition"
    partition_size_gb: 5
    selected_disk_name: "sdg"
    pv_strategy: "create_new_pv"
    vg_strategy: "create_new"
    volume_group_name: "vg_error1"
    filesystem_config: |
      - path: "/web"
        lv_name: "web_lv"
        size_mb: 2048
        fstype: "xfs"
      - path: "/database"
        lv_name: "db_lv"
        size_mb: 10000  # 10GB > 5GB partition
        fstype: "ext4"
  roles:
    - lvm_management
  # Expected Result:
  # ‚ùå FAIL at "Validate VG size"
  # ‚ùå total_requested_mb (12GB) > vg_free (5GB)
  # ‚ùå NO LVs created
  ignore_errors: yes

# ------------------ ERROR 2: DISK NOT FOUND ------------------
- name: "ERROR-2: Target Disk Does Not Exist"
  hosts: test_servers
  vars:
    partition_strategy: "create_partition"
    partition_size_gb: 5
    selected_disk_name: "sdz"  # ‚ùå Disk ‡πÑ‡∏°‡πà‡∏°‡∏µ
    pv_strategy: "create_new_pv"
    vg_strategy: "create_new"
    volume_group_name: "vg_error2"
    filesystem_config: |
      - path: "/test"
        lv_name: "test_lv"
        size_mb: 1024
        fstype: "xfs"
  roles:
    - lvm_management
  # Expected Result:
  # ‚ùå FAIL at "Create partition"
  # ‚ùå parted: /dev/sdz: No such file or directory
  ignore_errors: yes

# ------------------ ERROR 3: EXISTING PV NOT FOUND ------------------
- name: "ERROR-3: Existing PV Device Not Found"
  hosts: test_servers
  vars:
    partition_strategy: "use_whole_disk"
    pv_strategy: "use_existing_pv"
    existing_pv_device: "/dev/sdx99"  # ‚ùå PV ‡πÑ‡∏°‡πà‡∏°‡∏µ
    vg_strategy: "extend_existing"
    volume_group_name: "rootvg"
    filesystem_config: |
      - path: "/test"
        lv_name: "test_lv"
        size_mb: 1024
        fstype: "xfs"
  roles:
    - lvm_management
  # Expected Result:
  # ‚ùå FAIL at "Create/Extend VG"
  # ‚ùå Device /dev/sdx99 not found
  ignore_errors: yes

# ------------------ ERROR 4: VG NOT EXIST FOR EXTEND ------------------
- name: "ERROR-4: VG Does Not Exist for Extend"
  hosts: test_servers
  vars:
    partition_strategy: "use_whole_disk"
    selected_disk_name: "sdh"
    pv_strategy: "create_new_pv"
    vg_strategy: "extend_existing"
    volume_group_name: "vg_nonexist"  # ‚ùå VG ‡πÑ‡∏°‡πà‡∏°‡∏µ
    filesystem_config: |
      - path: "/test"
        lv_name: "test_lv"
        size_mb: 1024
        fstype: "xfs"
  roles:
    - lvm_management
  # Expected Result:
  # ‚ùå FAIL at "Create/Extend VG"
  # ‚ùå Volume group "vg_nonexist" not found
  ignore_errors: yes

# ------------------ ERROR 5: INVALID FILESYSTEM TYPE ------------------
- name: "ERROR-5: Invalid Filesystem Type"
  hosts: test_servers
  vars:
    partition_strategy: "create_partition"
    partition_size_gb: 3
    selected_disk_name: "sdi"
    pv_strategy: "create_new_pv"
    vg_strategy: "create_new"
    volume_group_name: "vg_error5"
    filesystem_config: |
      - path: "/test"
        lv_name: "test_lv"
        size_mb: 1024
        fstype: "ntfs"  # ‚ùå Unsupported FS
  roles:
    - lvm_management
  # Expected Result:
  # ‚ùå FAIL at "Create LV and filesystem"
  # ‚ùå mkfs.ntfs: command not found
  ignore_errors: yes

# ------------------ ERROR 6: PARTITION SIZE TOO LARGE ------------------
- name: "ERROR-6: Partition Size Exceeds Disk"
  hosts: test_servers
  vars:
    partition_strategy: "create_partition"
    partition_size_gb: 50  # ‚ùå 50GB > 10GB disk
    selected_disk_name: "sdj"
    pv_strategy: "create_new_pv"
    vg_strategy: "create_new"
    volume_group_name: "vg_error6"
    filesystem_config: |
      - path: "/test"
        lv_name: "test_lv"
        size_mb: 1024
        fstype: "xfs"
  roles:
    - lvm_management
  # Expected Result:
  # ‚ùå FAIL at "Create partition"
  # ‚ùå parted: The resulting partition is not properly aligned
  ignore_errors: yes

# ===============================================
# üîß TEST CONDITIONS SUMMARY
# ===============================================

# PASS CONDITIONS:
# ‚úÖ total_requested_mb ‚â§ vg_free_space
# ‚úÖ selected_disk_name exists (/dev/sdX)
# ‚úÖ partition_size_gb ‚â§ disk_size (for create_partition)
# ‚úÖ existing_pv_device exists (for use_existing_pv)
# ‚úÖ target VG exists (for extend_existing)
# ‚úÖ filesystem type supported (xfs, ext4, ext3, ext2)
# ‚úÖ Valid mount paths
# ‚úÖ LV names valid (alphanumeric, underscore, hyphen)

# ERROR CONDITIONS:
# ‚ùå total_requested_mb > vg_free_space
# ‚ùå selected_disk_name not found
# ‚ùå partition_size_gb > disk_size
# ‚ùå existing_pv_device not found
# ‚ùå VG not found (for extend_existing)
# ‚ùå Unsupported filesystem type
# ‚ùå Invalid mount paths
# ‚ùå LV name conflicts

# ===============================================
# üöÄ HOW TO RUN TESTS
# ===============================================

# Run all scenarios:
# ansible-playbook test_scenarios.yml

# Run specific scenario:
# ansible-playbook test_scenarios.yml --tags pass-1
# ansible-playbook test_scenarios.yml --tags error-1

# Run only PASS scenarios:
# ansible-playbook test_scenarios.yml --tags pass

# Run only ERROR scenarios:
# ansible-playbook test_scenarios.yml --tags error



